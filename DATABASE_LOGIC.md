# OCEAN PET - API Documentation & Database Logic

## üìã M·ª•c l·ª•c
1. [Database Schema](#database-schema)
2. [API Endpoints](#api-endpoints)
3. [Logic Flow](#logic-flow)
4. [Error Handling](#error-handling)
5. [Security](#security)

---

## üóÑÔ∏è Database Schema

### C√°c b·∫£ng ch√≠nh:

#### 1. **users** - Qu·∫£n l√Ω ng∆∞·ªùi d√πng
```sql
- id (PK)
- name, email (UNIQUE), password
- provider (email/google/facebook)
- avatar_url, is_verified
- otp_code, otp_expires_at
```

#### 2. **pets** - Th√∫ c∆∞ng
```sql
- id (PK), user_id (FK)
- name, type, breed, age, weight, gender
- avatar_url, notes
```

#### 3. **folders** - Th∆∞ m·ª•c nh·∫≠t k√Ω (t·ª´ pets)
```sql
- id (PK), user_id (FK)
- name (t√™n th√∫ c∆∞ng)
- icon, color
```

#### 4. **diary_entries** - Nh·∫≠t k√Ω
```sql
- id (PK), user_id (FK), folder_id (FK)
- title, description, category
- entry_date, entry_time
- bg_color, has_password, password
- is_deleted, deleted_at (soft delete - th√πng r√°c)
```

#### 5. **diary_images** - H√¨nh ·∫£nh nh·∫≠t k√Ω
```sql
- id (PK), diary_entry_id (FK)
- image_url, display_order
```

#### 6. **appointments** - L·ªãch h·∫πn
```sql
- id (PK), user_id (FK), pet_id (FK)
- title, description, appointment_date, appointment_time
- location, service_type, status
```

---

## üîå API Endpoints

### **Authentication**

#### 1. POST `/register`
```json
Request:
{
  "name": "string",
  "email": "string",
  "password": "string"
}

Response:
{
  "success": true,
  "message": "ƒêƒÉng k√Ω th√†nh c√¥ng",
  "userId": 1
}
```

#### 2. POST `/verify-otp`
```json
Request:
{
  "email": "string",
  "otp": "123456"
}

Response:
{
  "success": true,
  "message": "X√°c th·ª±c th√†nh c√¥ng"
}
```

#### 3. POST `/login`
```json
Request:
{
  "email": "string",
  "password": "string"
}

Response:
{
  "success": true,
  "token": "jwt_token",
  "user": {
    "id": 1,
    "name": "string",
    "email": "string",
    "avatarUrl": "string"
  }
}
```

#### 4. POST `/google-login` / `/facebook-login`
```json
Request:
{
  "accessToken": "oauth_access_token"
}

Response:
{
  "success": true,
  "token": "jwt_token",
  "user": {...}
}
```

### **User Management**

#### 5. GET `/user/:userId`
```json
Response:
{
  "success": true,
  "user": {
    "id": 1,
    "name": "string",
    "email": "string",
    "avatarUrl": "string"
  }
}
```

#### 6. PUT `/user/:userId`
```json
Request:
{
  "name": "string",
  "avatarUrl": "string"
}

Response:
{
  "success": true,
  "message": "C·∫≠p nh·∫≠t th√†nh c√¥ng",
  "user": {...}
}
```

### **Pets Management**

#### 7. GET `/pets/:userId`
```json
Response:
{
  "success": true,
  "pets": [
    {
      "id": 1,
      "name": "Mochi",
      "type": "Ch√≥",
      "breed": "Poodle",
      "age": 24,
      "weight": 5.5
    }
  ]
}
```

#### 8. POST `/pets`
```json
Request:
{
  "userId": 1,
  "name": "Mochi",
  "type": "Ch√≥",
  "breed": "Poodle",
  "age": 24,
  "weight": 5.5,
  "gender": "female"
}
```

### **Folders (Th∆∞ m·ª•c t·ª´ pets ƒë√£ ch·ªçn)**

#### 9. GET `/folders/:userId`
```json
Response:
{
  "success": true,
  "folders": [
    {
      "id": 1,
      "name": "Ch√≥",
      "icon": "üêï",
      "color": "#8B5CF6"
    }
  ]
}
```

#### 10. POST `/folders/sync`
```json
Request:
{
  "userId": 1,
  "selectedPets": ["Ch√≥", "M√®o", "C√°"]
}

Response:
{
  "success": true,
  "message": "ƒê√£ ƒë·ªìng b·ªô th∆∞ m·ª•c"
}
```

### **Diary Entries**

#### 11. GET `/diary/:userId`
```json
Response:
{
  "success": true,
  "entries": [
    {
      "id": 1,
      "title": "Mochi ƒÉn s√°ng",
      "description": "...",
      "category": "ƒÇn u·ªëng",
      "entryDate": "2025-09-17",
      "entryTime": "08:00:00",
      "folderId": 1,
      "folderName": "Ch√≥",
      "bgColor": "#FFF9E6",
      "hasPassword": false,
      "images": ["url1", "url2"]
    }
  ]
}
```

#### 12. POST `/diary`
```json
Request:
{
  "userId": 1,
  "folderId": 1,
  "title": "string",
  "description": "string",
  "category": "ƒÇn u·ªëng",
  "entryDate": "2025-09-17",
  "entryTime": "08:00:00",
  "bgColor": "#FFF9E6",
  "password": "optional_hashed_password",
  "images": ["url1", "url2"]
}
```

#### 13. PUT `/diary/:entryId`
```json
Request:
{
  "title": "string",
  "description": "string",
  "category": "ƒÇn u·ªëng",
  "folderId": 1,
  "bgColor": "#FFF9E6"
}
```

#### 14. DELETE `/diary/:entryId` (Soft delete - v√†o th√πng r√°c)
```json
Response:
{
  "success": true,
  "message": "ƒê√£ chuy·ªÉn v√†o th√πng r√°c"
}
```

#### 15. GET `/diary/trash/:userId`
```json
Response:
{
  "success": true,
  "trashedEntries": [
    {
      "id": 1,
      "title": "...",
      "deletedAt": "2025-09-17T10:00:00",
      "daysLeft": 25
    }
  ]
}
```

#### 16. POST `/diary/restore/:entryId`
```json
Response:
{
  "success": true,
  "message": "ƒê√£ kh√¥i ph·ª•c"
}
```

#### 17. DELETE `/diary/permanent/:entryId`
```json
Response:
{
  "success": true,
  "message": "ƒê√£ x√≥a vƒ©nh vi·ªÖn"
}
```

### **Appointments**

#### 18. GET `/appointments/:userId`
```json
Response:
{
  "success": true,
  "appointments": [
    {
      "id": 1,
      "title": "Kh√°m s·ª©c kh·ªèe",
      "appointmentDate": "2025-09-20",
      "appointmentTime": "10:00:00",
      "location": "Ph√≤ng kh√°m Pet Care",
      "serviceType": "Kh√°m s·ª©c kh·ªèe",
      "status": "confirmed"
    }
  ]
}
```

#### 19. POST `/appointments`
```json
Request:
{
  "userId": 1,
  "petId": 1,
  "title": "string",
  "description": "string",
  "appointmentDate": "2025-09-20",
  "appointmentTime": "10:00:00",
  "location": "string",
  "serviceType": "Kh√°m s·ª©c kh·ªèe"
}
```

---

## üîÑ Logic Flow

### **1. Flow ƒêƒÉng k√Ω & ƒêƒÉng nh·∫≠p**

```
1. User nh·∫≠p email/password ‚Üí POST /register
2. Backend:
   - Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i ch∆∞a
   - Hash password (bcrypt)
   - T·∫°o OTP code (6 s·ªë)
   - L∆∞u v√†o DB v·ªõi otp_expires_at = NOW() + 10 ph√∫t
   - G·ª≠i email OTP
3. User nh·∫≠p OTP ‚Üí POST /verify-otp
4. Backend:
   - Ki·ªÉm tra OTP v√† th·ªùi gian h·∫øt h·∫°n
   - Set is_verified = TRUE
   - Tr·∫£ v·ªÅ success
5. User ƒëƒÉng nh·∫≠p ‚Üí POST /login
6. Backend:
   - Ki·ªÉm tra email, password
   - Ki·ªÉm tra is_verified
   - T·∫°o JWT token
   - Tr·∫£ v·ªÅ token + user info
7. App l∆∞u token v√†o SharedPreferences
```

### **2. Flow Ch·ªçn th√∫ c∆∞ng & T·∫°o th∆∞ m·ª•c**

```
1. User ch·ªçn pets ·ªü ChoosePetScreen
2. App l∆∞u selected_pets v√†o SharedPreferences:
   ["Ch√≥", "M√®o", "C√°"]
3. POST /folders/sync v·ªõi userId v√† selectedPets
4. Backend:
   - X√≥a folders c≈© c·ªßa user
   - T·∫°o folders m·ªõi d·ª±a tr√™n selectedPets
   - M·ªói folder c√≥ name, icon, color t∆∞∆°ng ·ª©ng
5. Khi v√†o DiaryScreen:
   - GET /folders/:userId
   - Hi·ªÉn th·ªã folders trong Drawer
```

### **3. Flow Th√™m/S·ª≠a/X√≥a Nh·∫≠t k√Ω**

#### **Th√™m:**
```
1. User tap n√∫t "+" ‚Üí Hi·ªán dialog
2. User nh·∫≠p title, description, ch·ªçn category, folder
3. POST /diary v·ªõi data
4. Backend:
   - Insert v√†o diary_entries
   - N·∫øu c√≥ images: Insert v√†o diary_images
   - Tr·∫£ v·ªÅ entry m·ªõi
5. App c·∫≠p nh·∫≠t UI
```

#### **S·ª≠a:**
```
1. User tap v√†o entry ‚Üí V√†o DiaryDetailScreen
2. User tap v√†o text ‚Üí Inline edit (kh√¥ng qua dialog)
3. Khi blur/tap outside ‚Üí PUT /diary/:entryId
4. Backend c·∫≠p nh·∫≠t DB
5. App c·∫≠p nh·∫≠t local state
```

#### **X√≥a (Soft delete):**
```
1. User ch·ªçn "X√≥a" ‚Üí Confirm dialog
2. DELETE /diary/:entryId
3. Backend:
   - Set is_deleted = TRUE
   - Set deleted_at = NOW()
   - KH√îNG x√≥a kh·ªèi DB
4. Entry bi·∫øn m·∫•t kh·ªèi Diary nh∆∞ng v·∫´n ·ªü DB
5. GET /diary/trash/:userId ƒë·ªÉ hi·ªán trong TrashScreen
```

#### **Kh√¥i ph·ª•c:**
```
1. User v√†o TrashScreen ‚Üí Tap "Kh√¥i ph·ª•c"
2. POST /diary/restore/:entryId
3. Backend:
   - Set is_deleted = FALSE
   - Set deleted_at = NULL
4. Entry quay l·∫°i DiaryScreen
```

#### **X√≥a vƒ©nh vi·ªÖn:**
```
1. Sau 30 ng√†y, Event t·ª± ƒë·ªông ch·∫°y: CleanupTrashedEntries()
2. Ho·∫∑c user ch·ªçn "X√≥a vƒ©nh vi·ªÖn" ‚Üí DELETE /diary/permanent/:entryId
3. Backend DELETE FROM diary_entries WHERE id = ?
4. X√≥a h·∫≥n kh·ªèi DB
```

### **4. Flow Password Protection**

```
1. User ch·ªçn "ƒê·∫∑t m·∫≠t kh·∫©u" trong DiaryDetailScreen
2. Nh·∫≠p password ‚Üí Hash b·∫±ng bcrypt
3. PUT /diary/:entryId v·ªõi { password: hashed, hasPassword: true }
4. Khi m·ªü entry c√≥ password:
   - Hi·ªán PasswordDialog
   - User nh·∫≠p password
   - So s√°nh v·ªõi DB (bcrypt.compare)
   - N·∫øu ƒë√∫ng ‚Üí M·ªü entry
   - N·∫øu sai ‚Üí B√°o l·ªói
```

---

## ‚ö†Ô∏è Error Handling

### **Common Errors:**

```javascript
// 1. Network timeout
{
  success: false,
  message: "L·ªói k·∫øt n·ªëi sau 2 l·∫ßn th·ª≠: TimeoutException"
}

// 2. Invalid credentials
{
  success: false,
  message: "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng"
}

// 3. OTP expired
{
  success: false,
  message: "M√£ OTP ƒë√£ h·∫øt h·∫°n"
}

// 4. Duplicate entry
{
  success: false,
  message: "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng"
}

// 5. Unauthorized
{
  success: false,
  message: "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n"
}
```

### **Frontend Error Handling:**

```dart
try {
  final result = await AuthService.login(email, password);
  if (result['success']) {
    // Success flow
  } else {
    // Show error message
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(result['message']))
    );
  }
} catch (e) {
  // Network or unexpected error
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text('L·ªói k·∫øt n·ªëi: $e'))
  );
}
```

---

## üîí Security

### **1. Password Hashing:**
```javascript
const bcrypt = require('bcrypt');
const saltRounds = 10;
const hashedPassword = await bcrypt.hash(plainPassword, saltRounds);
```

### **2. JWT Token:**
```javascript
const jwt = require('jsonwebtoken');
const token = jwt.sign(
  { id: user.id, email: user.email },
  process.env.JWT_SECRET,
  { expiresIn: '7d' }
);
```

### **3. OTP Security:**
- OTP 6 s·ªë random
- H·∫øt h·∫°n sau 10 ph√∫t
- Ch·ªâ g·ª≠i qua email ƒë√£ ƒëƒÉng k√Ω

### **4. SQL Injection Prevention:**
```javascript
// ‚úÖ GOOD: S·ª≠ d·ª•ng parameterized queries
connection.query(
  'SELECT * FROM users WHERE email = ?',
  [email]
);

// ‚ùå BAD: String concatenation
connection.query(
  `SELECT * FROM users WHERE email = '${email}'`
);
```

### **5. Input Validation:**
```dart
// Frontend validation
validator: (value) {
  if (value == null || value.isEmpty) {
    return 'Vui l√≤ng nh·∫≠p email';
  }
  if (!RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$').hasMatch(value)) {
    return 'Email kh√¥ng h·ª£p l·ªá';
  }
  return null;
}
```

---

## üìä Database Indexes

```sql
-- Performance optimization
CREATE INDEX idx_diary_user_date ON diary_entries(user_id, entry_date, is_deleted);
CREATE INDEX idx_appointments_user_date ON appointments(user_id, appointment_date, status);
CREATE INDEX idx_email ON users(email);
```

---

## üîÑ Sync Logic (SharedPreferences ‚Üî Database)

### **L∆∞u v√†o SharedPreferences:**
```dart
final prefs = await SharedPreferences.getInstance();
await prefs.setString('auth_token', token);
await prefs.setString('user_id', userId);
await prefs.setStringList('selected_pets', ['Ch√≥', 'M√®o']);
```

### **ƒê·ªìng b·ªô v·ªõi Database:**
```
1. App kh·ªüi ƒë·ªông ‚Üí ƒê·ªçc selected_pets t·ª´ SharedPreferences
2. Hi·ªÉn th·ªã trong DiaryScreen Drawer
3. Khi c√≥ thay ƒë·ªïi:
   - C·∫≠p nh·∫≠t SharedPreferences
   - POST /folders/sync ƒë·ªÉ c·∫≠p nh·∫≠t DB
4. ƒê·∫£m b·∫£o consistency gi·ªØa app v√† server
```

---

## üß™ Testing Checklist

### **Authentication:**
- [ ] ƒêƒÉng k√Ω v·ªõi email h·ª£p l·ªá
- [ ] ƒêƒÉng k√Ω v·ªõi email ƒë√£ t·ªìn t·∫°i ‚Üí L·ªói
- [ ] X√°c th·ª±c OTP ƒë√∫ng
- [ ] X√°c th·ª±c OTP sai ‚Üí L·ªói
- [ ] X√°c th·ª±c OTP h·∫øt h·∫°n ‚Üí L·ªói
- [ ] ƒêƒÉng nh·∫≠p th√†nh c√¥ng
- [ ] ƒêƒÉng nh·∫≠p v·ªõi email ch∆∞a x√°c th·ª±c ‚Üí L·ªói

### **Diary:**
- [ ] Th√™m entry m·ªõi
- [ ] S·ª≠a entry (inline edit)
- [ ] X√≥a entry ‚Üí V√†o th√πng r√°c
- [ ] Kh√¥i ph·ª•c t·ª´ th√πng r√°c
- [ ] X√≥a vƒ©nh vi·ªÖn t·ª´ th√πng r√°c
- [ ] T·ª± ƒë·ªông x√≥a sau 30 ng√†y
- [ ] Th√™m h√¨nh ·∫£nh
- [ ] ƒê·∫∑t m·∫≠t kh·∫©u
- [ ] Th√™m v√†o th∆∞ m·ª•c

### **Folders:**
- [ ] ƒê·ªìng b·ªô t·ª´ selected_pets
- [ ] Hi·ªÉn th·ªã ƒë√∫ng trong Drawer
- [ ] L·ªçc entries theo folder

---

## üìù Notes

1. **SharedPreferences ch·ªâ l∆∞u UI state**, database l√† source of truth
2. **Soft delete** cho diary entries ƒë·ªÉ c√≥ th·ªÉ kh√¥i ph·ª•c
3. **JWT token** h·∫øt h·∫°n sau 7 ng√†y, c·∫ßn refresh ho·∫∑c login l·∫°i
4. **OTP** h·∫øt h·∫°n sau 10 ph√∫t
5. **Th√πng r√°c** t·ª± ƒë·ªông d·ªçn d·∫πp sau 30 ng√†y
